---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

Target Markdown is a powerful R Markdown interface for reproducible analysis
pipelines, and the chapter at https://books.ropensci.org/targets/markdown.html
walks through it in detail. This R Markdown report the example from the chapter.
Try it out in both interactive and non-interactive modes, either by running the
code chunks in different ways or setting the `tar_interactive` chunk option.

# Packages

The example requires several R packages, and `targets` must be version 0.5.0.9000 or above.

```{r}
pkg <- c("tidyverse", "magrittr", "cowplot", "here", "arrow",
    "easystats", "glmmTMB", "ggcorrplot", "kableExtra")
```

```{r, eval = FALSE}
install.packages(pkg)
```

# Setup

If you are using old versions of `targets` (<= 0.7.0) and/or `knitr` (<= 1.33),
you will need to load the `targets` package in the R Markdown document in order
for Target Markdown code chunks to work.

Near the top of the document, you may also wish to remove the `_targets_r`
directory previously written by non-interactive runs of the report. Otherwise,
your pipeline may contain superfluous targets.

```{r}
library(targets)
tar_unscript()
```

# Globals

We first define some global options/functions common to all targets.

```{targets example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
pkg <- c("tidyverse", "magrittr", "cowplot", "here", "arrow",
    "easystats", "glmmTMB", "ggcorrplot", "kableExtra")
tar_option_set(packages = pkg)
dir_fun <- here::here("R")

# Source all the R files
lapply(
  X = list.files(
    path = dir_fun,
    pattern = "\\.R$",
    full.names = TRUE,
    all.files = TRUE,
    recursive = TRUE
  ),
  FUN = source)
```

# Targets

Our first target borrows the `airquality` dataset built into base R.

```{targets old-load-data, eval = FALSE}
list(
  tar_target(sim_total,
    open_dataset(here("data", "sim_total.arrow"), format = "arrow") %>%
      collect()
  ),
  tar_target(sim_param,
    open_dataset(here("data", "sim_param.arrow"), format = "arrow") %>%
      collect()
  ),
  tar_target(sim, sim_param %>%
    select(-fw, nb_link, Z) %>%
    left_join(sim_total) %>%
    select(sim_id, S, C, Z, nb_link, fw, rep, everything())
  )
)
```


```{targets load-data}
list(
  tar_target(new_sim_file,
    list.files(here("data"), full.names = TRUE)[str_detect(list.files(here("data")), "sim_\\d.*_\\d.*arrow")],
    format = "file"
    ),
  tar_target(sim_total,
    map_dfr(new_sim_file,
      ~open_dataset(.x, format = "arrow") %>%
        collect()
      )),
  tar_target(sim_param,
    open_dataset(here("data", "sim_param.arrow"), format = "arrow") %>%
      collect()
    ),
  tar_target(sim, sim_param %>%
    select(-fw, nb_link, Z) %>%
    left_join(sim_total) %>%
    select(sim_id, S, C, Z, nb_link, fw, rep, everything())
  )
)
```


## Raw simulation data explanation

- Every food-web (`fw_id`) was ran according to three sequential `scenario`:
  - `pred_present`: The predator is present
  - `pred_extirpated`: We then extirpated the predator
  - `pred_reintroduced`: lastly, we reintroduced the predator!

- We collected a bunch of metrics for each simulation:
  - `fw_id`
  - `scenario`
  - `richness`, `persistence`
  - `bm_sp`: vector of species biomass
  - `bm_total`
  - `bm_pred`, `bm_cons`, `bm_prod`: predator, consumer, and primary producer
    biomass
  - `bm_init_pred`, `bm_init_cons`, `bm_init_prod`: Same than above for initial
    biomass
  - `species_alive`: vector of species alive among `bm_sp`
  - `A_alive`, `A_init`: interaction matrix of alive species, and initial
    interaction matrix
  - `tlvl`: vector of species trophic level
  - `tlvl_max`, `tlvl_mean`, `tlvl_w_mean`: max, mean and weighted mean
  - `omnivory`, `omnivory_mean`: vector of omnivory values, avg
  - `cv_com`, `cv_species_mean`, `cv_species`: community, average species cv, and
    vector of species cv
  - `int_mean`, `int_per_cap_mean`: avg and per capita avg interaction
  - `richness_init`, `bm_init`: initial richness and biomass
  - `tlvl_extirpated`, `tlvl_introduced`:
  - `i_extirpated`, `i_introduced`:




```{targets check_data}
list(
  tar_target(failed_sim,
    sim %>%
      filter(is.na(scenario))
    ),
  tar_target(sim_rich_scenar,
    sim %>%
      filter(!is.na(scenario)) %>%
      select(sim_id, scenario, richness) %>%
      pivot_wider(names_from = scenario, values_from = richness)
    ),
  tar_target(imp_rich_scenar,
    sim_rich_scenar %>%
      filter(pred_extirpated > pred_present | pred_reintroduced > pred_present)
  )
)
```

```{targets summary-sim}
list(
  tar_target(pred_sim_id,
    sim_total %>%
      group_by(sim_id) %>%
      summarise(
        target_pred = unique(na.omit(
            c(species_extirpated, species_introduced))))
      ),
  tar_target(sim_com_output,
    sim_total %>%
      mutate(
        bm_evenness = map_dbl(bm_sp,
          ~vegan::diversity(.x, index = "shannon")/length(.x)),
      ) %>%
      select(sim_id, scenario, connectance, stab_com, bm_total, tlvl_w_mean, bm_evenness) %>%
      mutate(scenario = str_remove(scenario, "pred_")) %>%
      pivot_wider(
        names_from = scenario,
        names_glue = "{.value}_{scenario}",
        values_from = c(connectance, stab_com, bm_total, tlvl_w_mean, bm_evenness)
      )
    ),
  tar_target(richness_wo_pred,
    sim_total %>%
      left_join(pred_sim_id) %>%
      mutate(
        richness_wo_pred = map2_int(species_alive, target_pred,
          function(alive, pred) {
            out <- which(alive == pred)
            # if predator is alive, decrease richness by 1
            ifelse(length(out) == 0,
              length(alive),
              length(alive) - 1
            )
          }
          ),
        ) %>%
      select(sim_id, scenario, richness, richness_wo_pred) %>%
      mutate(scenario = str_remove(scenario, "pred_")) %>%
      pivot_wider(
        names_from = scenario,
        names_glue = "{.value}_{scenario}",
        values_from = c(richness, richness_wo_pred)
        )),
  tar_target(pred_survive_reintro,
    sim_total %>%
      filter(scenario == "pred_reintroduced") %>%
      left_join(pred_sim_id) %>%
      mutate(
        pred_survive_reintro = map2_lgl(species_alive, target_pred,
          function(alive, pred) {
            out <- which(alive == pred)
            ifelse(length(out) == 0, FALSE, TRUE)
          }
          ),
        ) %>%
      select(sim_id, pred_survive_reintro)
    ),
  tar_target(sim_pred_output,
    sim_total %>%
      filter(scenario != "pred_extirpated") %>%
      left_join(pred_sim_id) %>%
      mutate(
        id_target_pred = map2_int(species, target_pred, ~which(.x == .y)),
        id_alive_target_pred = map2_int(species_alive, target_pred,
          function(x, y) {
            out <- which(x == y)
            # if predator is not alive
            ifelse(length(out) == 0, NA, out)
          }
          ),
        bm_target_pred = map2_dbl(bm_sp, id_target_pred, ~.x[.y]),
        stab_target_pred = map2_dbl(stab_species, id_alive_target_pred, ~.x[.y]),
        tlvl_target_pred = map2_dbl(tlvl, id_target_pred, ~.x[.y])
        ) %>%
      select(sim_id, scenario, bm_target_pred, stab_target_pred, tlvl_target_pred)
    ),
  tar_target(sim_pred_output_wide,
    sim_pred_output %>%
      mutate(scenario = str_remove(scenario, "pred_")) %>%
      pivot_wider(
        names_from = scenario,
        names_glue = "{.value}_{scenario}",
        values_from = c(bm_target_pred, stab_target_pred, tlvl_target_pred)
      )
    ),
  tar_target(sim_pred_link,
    sim_total %>%
      filter(scenario != "pred_extirpated") %>%
      left_join(pred_sim_id) %>%
      mutate(
        fw_mat = map(fw, ~matrix(.x, nrow = sqrt(length(.x)))),
        id_target_pred = map2_int(species, target_pred, ~which(.x == .y)),
        nb_link_target_pred = map2_int(fw_mat, id_target_pred, ~sum(.x[.y,]))
      ) %>%
      select(sim_id, scenario, nb_link_target_pred) %>%
      pivot_wider(
        names_from = "scenario",
        values_from = "nb_link_target_pred"
        ) %>%
      rename_with(~str_replace(.x, "pred_", "nb_link_target_pred_"))
    ),
  tar_target(sim_summary,
    sim_com_output %>%
      left_join(sim_pred_link) %>%
      left_join(sim_pred_output_wide) %>%
      left_join(pred_survive_reintro) %>%
      left_join(richness_wo_pred)
    ),
  tar_target(sim_tom,
    sim_summary %>%
      mutate(
        #realised_C_1 (connectance in the intact community)
        realised_C_1 = connectance_present,
        #realised_C_2 (connectance in the extirpated community)
        realised_C_2 = connectance_extirpated,
        #realised_C_3 (connectance in the reintroduced community)
        realised_C_3 = connectance_reintroduced,
        #realised_S_1 (richness in the intact community, excluding the predator)
        realised_S_1 = richness_wo_pred_present,
        #realised_S_2 (richness in the extirpated community, excluding the predator obvs)
        realised_S_2 = richness_wo_pred_extirpated,
        #realised_S_3 (richness in the reintroduced community, excluding the predator)
        realised_S_3 = richness_wo_pred_reintroduced,
        #z_1 (ppmr in the intact community)
        #g_1 (number of links between the top/removed predator and other species)
        g_1 = nb_link_target_pred_present,
        #g_3 (number of remaining links between the top/removed predator and other species i.e. does the predator still have all its prey alive)
        g_3 = nb_link_target_pred_reintroduced,
        #cv_com_1 (community stability in the intact phase)
        stab_com_1 = stab_com_present,
        #cv_com_2 (community stability in the extirpated phase)
        stab_com_2 = stab_com_extirpated,
        #tlvl_mean_1 (mean trophic level in the intact phase)
        tlvl_mean_1 = tlvl_w_mean_present,
        #tlvl_mean_2 (mean trophic level in the exirpated phase)
        tlvl_mean_2 = tlvl_w_mean_extirpated,
        # evenness 1 (evenness in the intact community),
        evenness_1 = bm_evenness_present,
        # evenness 2 (evenness in the exirpated phase),
        evenness_2 = bm_evenness_extirpated,
        # evenness 3 (evenness in the reintroduced community),
        evenness_3 = bm_evenness_reintroduced,
        #delta_ev_21 = (evenness in the extirpated stage / evenness in the intact stage),
        delta_ev_21 = evenness_2/evenness_1,
        #delta_ev_31 = (evenness in the reintroduced stage / evenness in the intact stage),
        delta_ev_31 = evenness_3/evenness_1,
        #delta_ev_32 = (evenness in the reintroduced stage/evenness in the extirpated stage),
        delta_ev_32 = evenness_3/evenness_2,
        #delta_s_21 = (realised_S_2/realised_S_1),
        delta_s_21 = richness_wo_pred_extirpated / richness_wo_pred_present,
        #delta_s_32 = (realised_S_3/realised_S_2),
        delta_s_32 = richness_wo_pred_reintroduced / richness_wo_pred_extirpated,
        #delta_bmc_21 = (community biomass in the extirpated stage/community biomass in the intact stage),
        delta_bmc_21 = bm_total_extirpated / bm_total_present,
        #delta_bmc_32 (community biomass in the reintroduced stage/community biomass in the extirpated stage)
        delta_bmc_32 = bm_total_reintroduced / bm_total_extirpated,
        #delta_cvc_21 (community stability in the extirpated stage/community stability in the intact stage)
        delta_stabc_21 = stab_com_extirpated / stab_com_present,
        #delta_cvc_32 (community stability in the reintroduced stage/community stability in the extirpated stage)
        delta_stabc_32 = stab_com_reintroduced / stab_com_extirpated,
        #delta_g_31 (g_3/g_1)
        delta_g_31 = nb_link_target_pred_reintroduced / nb_link_target_pred_present,
        #delta_sp_32 (predator survives reintroduction)
        delta_sp_32  = pred_survive_reintro,
        #delta_bmp_31 (predator biomass in the reintroduced stage/predator biomass in the intact stage)
        delta_bmp_31 = bm_target_pred_reintroduced / bm_target_pred_present,
        #delta_cvp_31 (predator population stability in the reintroduced stage/predator population stability in the intact stage)
        delta_stabp_31 = stab_target_pred_reintroduced / stab_target_pred_present
      ) %>%
    select(sim_id, realised_C_1:delta_stabp_31)
  ),
  tar_target(sim_tom_ok,
  sim_param %>%
    select(sim_id, Z, nb_link, rep) %>%
    left_join(sim_tom)
  ),
  tar_target(sim_tom_ok_export,
    save(sim_tom_ok, file = "sim_tom_ok.Rdata")
  )
)
```

```{targets species-data, eval = FALSE}
list(
  tar_target(sim_bm_sp,
    sim %>%
      select(sim_id, scenario, species, bm_sp) %>%
      mutate(
        com = map2(species, bm_sp,
          ~tibble(species = .x, biomass = .y)
        )
        ) %>%
      select(-species, -bm_sp) %>%
      group_by(sim_id) %>%
      nest() %>%
      mutate(
        data = map(data, function(x) {
          x %>%
            unnest(cols = c(com)) %>%
            pivot_wider(names_from = "species", values_from = "biomass") %>%
            mutate(across(where(is.double), ~ifelse(is.na(.x), 0, .x))) %>%
            pivot_longer(where(is.double), names_to = "species", values_to = "biomass")
        })
        ) %>%
      unnest(cols = c(data))

    )


)
```



# Make targets

```{r make}
ncpu <- future::availableCores()
if (ncpu > 4) {
  tar_make_future(workers = min(future::availableCores() - 1, 24))
} else {
  tar_make()
}
```

The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r}
tar_visnetwork()
```

At this point, you can go back and run `{targets}` chunks in interactive mode without interfering with the code or data of the non-interactive pipeline.

# Output

```{r load-fun}
library(targets)
sapply(pkg, require, character.only = TRUE)

dir_fun <- here::here("R")
lapply(
  X = list.files(
    path = dir_fun,
    pattern = "\\.R$",
    full.names = TRUE,
    all.files = TRUE,
    recursive = TRUE
  ),
  FUN = source)
```

## Pre-processed simulation data

```{r}
tar_load(sim_tom_ok)
#summary(sim_tom_ok)
```

### Variable explanation

Here is the explanation of each variable in the dataset (`sim_tom_ok.Rdata`)
pre-processed for statistical analysis:

- Simulation parameters:
  - `sim_id`: ID of the simulation
  - `Z`: Predator-prey Mass Ratio (see Brose et al. (2006))
  - `nb_link`: Fixed number of trophic links of the reintroduced predator. If
    `NA`, it means that we did not change the number of trophic links of the
    reintroduced predator
  - `rep`: ID of the simulation replicate
- Output metrics:
  - `realised_C_1`: connectance in the intact community
  - `realised_C_2`: connectance in the extirpated community
  - `realised_C_3`: connectance in the reintroduced community
  - `realised_S_1`: richness in the intact community, excluding the predator
  - `realised_S_2`: richness in the extirpated community, excluding the predator obvs
  - `realised_S_3`: richness in the reintroduced community, excluding the predator
  - `z_1`: ppmr in the intact community
  - `g_1`: number of trophic links of the predator in the intact
    community (at the begining of the simulation)
  - `g_3`: number of trophic links of the predator in the reintroduced
    phase (at the begining of the simulation)
  - `stab_com_1`: community stability in the intact phase
  - `stab_com_2`: community stability in the extirpated phase
  - `tlvl_mean_1`: mean trophic level in the intact phase
  - `tlvl_mean_2`: mean trophic level in the exirpated phase
  - `delta_s_21`: `realised_S_2`/`realised_S_1`,
  - `delta_s_32`: `realised_S_3`/`realised_S_2`,
  - `delta_bmc_21`: community biomass in the extirpated stage/community biomass
    in the intact stage,
  - `delta_bmc_32`: community biomass in the reintroduced stage/community
    biomass in the extirpated stage
  - `delta_stabc_21`: community stability in the extirpated stage/community
    stability in the intact stage
  - `delta_stabc_32`: community stability in the reintroduced stage/community
    stability in the extirpated stage
  - `delta_g_31`: `g_3`/`g_1`
  - `delta_sp_32`: predator survives reintroduction
  - `delta_bmp_31`: predator biomass in the reintroduced stage/predator biomass
    in the intact stage
  - `delta_stabp_31`: predator population stability in the reintroduced
     / intact stages


```{r draft-check, eval = FALSE}
load("~/Downloads/sim_tom_ok")
tar_load(sim_bm_sp)
tar_load_globals()
tar_load(sim)
tar_load(sim_param)
sim %>%
  select(sim_id, species, species_alive, bm_sp, stab_species)

sim_species_stab <- sim %>%
  filter(sim_id %in% c(10000, 41000, 65000)) %>%
  select(sim_id, scenario, species, stab_species) %>%
  mutate(
    com = map2(species_alive, stab_species,
      ~tibble(species = .x, stability = .y)
    )
    ) %>%
  select(-species_alive, -stab_species) %>%
  group_by(sim_id) %>%
  nest() %>%
  mutate(
    data = map(data, function(x) {
      x %>%
        unnest(cols = c(com)) %>%
        pivot_wider(names_from = "species", values_from = "stability") %>%
        mutate(across(where(is.double), ~ifelse(is.na(.x), 0, .x))) %>%
        pivot_longer(where(is.double), names_to = "species", values_to = "stability")
    })
    ) %>%
  unnest(cols = c(data))

ti <- sim %>%
  filter(sim_id == 1) %>%
  select(sim_id, scenario, species, species_alive, bm_sp, stab_species)
ti$species
ti$bm_sp
ti %<>%
  mutate(
    com = map2(ti$species, ti$bm_sp,
      ~tibble(species = .x, biomass = .y)
    )
  )
ti %>%
  select(sim_id, scenario, com) %>%
  unnest(cols = c(com)) %>%
  pivot_wider(names_from = "species", values_from = "biomass") %>%
  mutate(across(where(is.double), ~ifelse(is.na(.x), 0, .x))) %>%
  pivot_longer(where(is.double), names_to = "species", values_to = "biomass")
to <- sim %>%
  select(sim_id, scenario, species, bm_sp) %>%
  mutate(
    com = map2(species, bm_sp,
      ~tibble(species = .x, biomass = .y)
    )
  ) %>%
  select(-species, -bm_sp) %>%
  group_by(sim_id) %>%
  nest() %>%
  mutate(
    data = map(data, function(x) {
      x %>%
        unnest(cols = c(com)) %>%
        pivot_wider(names_from = "species", values_from = "biomass") %>%
        mutate(across(where(is.double), ~ifelse(is.na(.x), 0, .x))) %>%
        pivot_longer(where(is.double), names_to = "species", values_to = "biomass")
    })
  ) %>%
  unnest(cols = c(data))

tu <- to %>%
  filter(sim_id %in% c(10000, 41000, 65000)) %>%
  select(sim_id, scenario, com) %>%
  group_by(sim_id)
#Â Nest, do the pivoting and unnest
tu2 <- tu %>%
  nest() %>%
  mutate(
    data = map(data, function(x) {
      x %>%
        unnest(cols = c(com)) %>%
        pivot_wider(names_from = "species", values_from = "biomass") %>%
        mutate(across(where(is.double), ~ifelse(is.na(.x), 0, .x))) %>%
        pivot_longer(where(is.double), names_to = "species", values_to = "biomass")
    })
  )
  tu2
  tu2 <- tu %>%
  nest()
tu2$data[[1]]
tu2 %<>%
  unnest(cols = c(data))
unique(tu2[tu2$sim_id == 10000, ]$species)
unique(tu2[tu2$sim_id == 41000, ]$species)
unique(tu2[tu2$sim_id == 65000, ]$species)

to <- sim %>%
  filter(sim_id %in% c(10000, 40000, 65000)) %>%
  select(sim_id, scenario, species, bm_sp) %>%
  mutate(
    com = map2(species, bm_sp,
      ~tibble(species = .x, biomass = .y)
    )
  )
```




```{r, include=FALSE}
knitr::opts_chunk$set(eval = FALSE, include = FALSE, comment = "#>")
```


```{r, eval = FALSE}
tar_load(sim_total)
sim_toy <- sim_total %>%
  filter(sim_id %in% c(1:5))
sim_toy$species_extirpated
sim_toy$species_introduced

pred_sim_id <- sim_toy %>%
  group_by(sim_id) %>%
  summarise(target_pred = unique(na.omit(c(species_extirpated, species_introduced))))

nb_link <- sim_toy %>%
  filter(scenario != "pred_extirpated") %>%
  left_join(pred_sim_id) %>%
  mutate(
    fw_mat = map(fw, ~matrix(.x, nrow = sqrt(length(.x)))),
    id_target_pred = map2_int(species, target_pred, ~which(.x == .y)),
    nb_link_pred = map2_int(fw_mat, id_target_pred, ~sum(.x[.y,]))
  ) %>%
  select(sim_id, scenario, nb_link_pred, nb_link_extirpated, nb_link_introduced)

richness_wo_pred <- sim_toy %>%
  left_join(pred_sim_id) %>%
  mutate(
    richness_wo_pred = map2_int(species_alive, target_pred,
      function(alive, pred) {
        out <- which(alive == pred)
        # if predator is alive, decrease richness by 1
        ifelse(length(out) == 0,
          length(alive),
          length(alive) - 1
        )
      }
      ),
  ) %>%
  select(sim_id, scenario, richness, richness_wo_pred) %>%
  mutate(scenario = str_remove(scenario, "pred_")) %>%
  pivot_wider(
    names_from = scenario,
    names_glue = "{.value}_{scenario}",
    values_from = c(richness, richness_wo_pred)
    )


pred_survive_reintro <- sim_toy %>%
  filter(scenario == "pred_reintroduced") %>%
  left_join(pred_sim_id) %>%
  mutate(
    pred_survive_reintro = map2_lgl(species_alive, target_pred,
      function(alive, pred) {
        out <- which(alive == pred)
        ifelse(length(out) == 0, FALSE, TRUE)
      }
      ),
  ) %>%
  select(sim_id, pred_survive_reintro)


sim_pred_output <- sim_toy %>%
  filter(scenario != "pred_extirpated") %>%
  left_join(pred_sim_id) %>%
  mutate(
    id_target_pred = map2_int(species, target_pred, ~which(.x == .y)),
    id_alive_target_pred = map2_int(species_alive, target_pred,
      function(x, y) {
        out <- which(x == y)
        # if predator is not alive
        ifelse(length(out) == 0, NA, out)
      }
      ),
    bm_target_pred = map2_dbl(bm_sp, id_target_pred, ~.x[.y]),
    stab_target_pred = map2_dbl(stab_species, id_alive_target_pred, ~.x[.y]),
    tlvl_target_pred = map2_dbl(tlvl, id_target_pred, ~.x[.y])
  ) %>%
  select(sim_id, scenario, bm_target_pred, stab_target_pred, tlvl_target_pred)

sim_pred_output_wide <- sim_pred_output %>%
  mutate(scenario = str_remove(scenario, "pred_")) %>%
  pivot_wider(
    names_from = scenario,
    names_glue = "{.value}_{scenario}",
    values_from = c(bm_target_pred, stab_target_pred, tlvl_target_pred)
    )

sim_pred_link <- sim_toy %>%
  filter(scenario != "pred_present") %>%
  select(sim_id, scenario, nb_link_extirpated, nb_link_introduced) %>%
  mutate(
    nb_link_target_pred = map2_int(
      nb_link_extirpated,
      nb_link_introduced,
      ~unique(na.omit(c(.x, .y)))
    )
  ) %>%
  select(sim_id, scenario, nb_link_target_pred) %>%
  pivot_wider(
    names_from = "scenario",
    values_from = "nb_link_target_pred"
    ) %>%
  rename_with(~str_replace(.x, "pred_", "nb_link_target_pred_"))

sim_toy <- sim_total %>%
  filter(sim_id %in% c(65000:65005))
pred_sim_id <- sim_toy %>%
  group_by(sim_id) %>%
  summarise(target_pred = unique(na.omit(c(species_extirpated, species_introduced))))

sim_summary <- sim_com_output %>%
  left_join(sim_pred_link) %>%
  left_join(sim_pred_output_wide) %>%
  left_join(pred_survive_reintro) %>%
  left_join(richness_wo_pred)

sim_tom <- sim_summary %>%
  mutate(
    #realised_C_1 (connectance in the intact community)
    realised_C_1 = connectance_present,
    #realised_C_2 (connectance in the extirpated community)
    realised_C_2 = connectance_extirpated,
    #realised_C_3 (connectance in the reintroduced community)
    realised_C_3 = connectance_reintroduced,
    #realised_S_1 (richness in the intact community, excluding the predator)
    realised_S_1 = richness_wo_pred_present,
    #realised_S_2 (richness in the extirpated community, excluding the predator obvs)
    realised_S_2 = richness_wo_pred_extirpated,
    #realised_S_3 (richness in the reintroduced community, excluding the predator)
    realised_S_3 = richness_wo_pred_reintroduced,
    #z_1 (ppmr in the intact community)
    #g_1 (number of links between the top/removed predator and other species)
    g_1 = nb_link_target_pred_extirpated,
    #g_3 (number of remaining links between the top/removed predator and other species i.e. does the predator still have all its prey alive)
    g_3 = nb_link_target_pred_reintroduced,
    #cv_com_1 (community stability in the intact phase)
    cv_com_1 = stab_com_present,
    #cv_com_2 (community stability in the extirpated phase)
    cv_com_2 = stab_com_extirpated,
    #tlvl_mean_1 (mean trophic level in the intact phase)
    tlvl_mean_1 = tlvl_w_mean_present,
    #tlvl_mean_2 (mean trophic level in the exirpated phase)
    tlvl_mean_2 = tlvl_w_mean_extirpated,
    #delta_s_21 = (realised_S_2/realised_S_1),
    delta_s_21 = richness_wo_pred_extirpated / richness_wo_pred_present,
    #delta_s_32 = (realised_S_3/realised_S_2),
    delta_s_32 = richness_wo_pred_reintroduced / richness_wo_pred_extirpated,
    #delta_bmc_21 = (community biomass in the extirpated stage/community biomass in the intact stage),
    delta_bmc_21 = bm_total_extirpated / bm_total_present,
    #delta_bmc_32 (community biomass in the reintroduced stage/community biomass in the extirpated stage)
    delta_bmc_32 = bm_total_reintroduced / bm_total_extirpated,
    #delta_cvc_21 (community stability in the extirpated stage/community stability in the intact stage)
    delta_cvc_21 = stab_com_extirpated / stab_com_present,
    #delta_cvc_32 (community stability in the reintroduced stage/community stability in the extirpated stage)
    delta_cvc_32 = stab_com_reintroduced / stab_com_extirpated,
    #delta_g_31 (g_3/g_1)
    delta_g_31 = nb_link_target_pred_reintroduced / nb_link_target_pred_extirpated,
    #delta_sp_32 (predator survives reintroduction)
    delta_sp_32  = pred_survive_reintro,
    #delta_bmp_31 (predator biomass in the reintroduced stage/predator biomass in the intact stage)
    delta_bmp_31 = bm_target_pred_reintroduced / bm_target_pred_present,
    #delta_cvp_31 (predator population stability in the reintroduced stage/predator population stability in the intact stage)
    delta_cvp_31 = stab_target_pred_reintroduced / stab_target_pred_present
  )
```




```{r}
tar_load(sim_param)
tar_load(sim)


save(sim, file = here("data", "sim.RData"))
```




- Should discard foodweb that had persistence less than 80% as Toby did

```{r}
tar_load(c(param_CS, simCS))

# Only few replicates have a low persistence
simCS %>%
  filter(scenario == "pred_present", persistence < .8)
# All food-webs have predators
simCS %>%
  filter(scenario == "pred_present", tlvl_max < 2)

simCS %<>%
  mutate(
    mean_cv_pop = map_dbl(cv_species, mean)
  ) %>%
  select(!where(is.list)) %>%
  left_join(param_CS %>% select(!where(is.list))) %>%
  mutate(
    scenario = factor(scenario,
      levels = c("pred_present", "pred_extirpated", "pred_reintroduced")),
    stab_com = 1 / cv_com,
    avg_stab_pop = 1 / cv_species_mean,
    mean_stab_pop = 1 / mean_cv_pop

  ) %>%
  relocate(all_of(c("stab_com", "avg_stab_pop", "mean_stab_pop")), .after = richness) %>%
  select(-cv_com, -cv_species_mean, -mean_cv_pop)

```

## Predator removal

```{r}
p_stab_com <- simCS %>%
  ggplot(aes(y = log(stab_com), x = S, color = scenario)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    y = "Community stability",
    x = "Initial foodweb richness",
    color = "Scenario"
    ) +
  facet_grid(cols = vars(C)) +
  theme_bw() +
  theme(legend.position = "bottom")

p_avg_stab_pop <- simCS %>%
  ggplot(aes(y = log(avg_stab_pop), x = S, color = scenario)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    y = "Average population stability (weighted)",
    x = "Initial foodweb richness",
    color = "Scenario"
    ) +
  facet_grid(cols = vars(C)) +
  theme_bw() +
  theme(legend.position = "bottom")

p_mean_stab_pop <- simCS %>%
  ggplot(aes(y = log(mean_stab_pop), x = S, color = scenario)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(
    y = "Mean population stability (non weighted)",
    x = "Initial foodweb richness",
    color = "Scenario"
    ) +
  facet_grid(cols = vars(C)) +
  theme_bw() +
  theme(legend.position = "bottom")

leg <- get_legend(p_avg_stab_pop)

p_toby_res <- plot_grid(
  p_mean_stab_pop + theme(legend.position = "none"),
  p_stab_com + theme(legend.position = "none"),
  p_avg_stab_pop+ theme(legend.position = "none"),
  leg,
  nrow = 4,
  rel_heights = c(1, 1, 1, .2)
)

ggsave(
  here::here("report", "figs", "p_toby_res.png"),
  plot = p_toby_res,
  scale = 2.4,
  width = 140,
  height = 140 * .8,
  units = "mm"
)
```


```{r}
exp_effect <- simCS %>%
  select(-c(richness_init:tlvl_introduced)) %>%
  pivot_longer(richness:int_per_cap_mean,
    names_to = "metric", values_to = "values") %>%
  pivot_wider(names_from = "scenario", values_from = "values") %>%
  mutate(
    effect_extirpation = pred_extirpated - pred_present,
    effect_extirpation_ratio = effect_extirpation / pred_present,
    effect_reintro = pred_reintroduced - pred_extirpated,
    effect_reintro_ratio = effect_reintro / pred_extirpated,
    effect_resilience = pred_reintroduced - pred_present,
    effect_resilience_ratio = effect_resilience / pred_present
  )
```

```{r}
p_extirpation_effect <- exp_effect %>%
  filter(effect_extirpation_ratio < 5) %>%
  ggplot(aes(x = as.factor(S), y = effect_extirpation_ratio, color = as.factor(C))) +
  geom_boxplot() +
  geom_hline(yintercept = 0)+
  labs(
    y = "Extirpation effect (extirpated - pred present)/pred present",
    x = "Initial foodweb richness",
    color = "Connectance"
    ) +
  facet_wrap(~metric, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  here::here("report", "figs", "p_extirpation_effect.png"),
  plot = p_extirpation_effect,
  scale = 2,
  width = 140,
  height = 140 * .5,
  units = "mm"
)
```


```{r}
p_effect_reintro <- exp_effect %>%
  filter(abs(effect_reintro_ratio) < 5) %>%
  ggplot(aes(x = as.factor(S), y = effect_reintro_ratio, color = as.factor(C))) +
  geom_boxplot() +
  labs(
    y = "Reintroduction effect (reintro - extirpated)/extirpated",
    x = "Initial foodweb richness",
    color = "Connectance"
    ) +
  geom_hline(yintercept = 0)+
  facet_wrap(~metric, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  here::here("report", "figs", "p_reintro_effect.png"),
  plot = p_effect_reintro,
  scale = 2,
  width = 140,
  height = 140 * .5,
  units = "mm"
)
```

```{r}
p_resilience_effect <- exp_effect %>%
  filter(effect_resilience_ratio < 5) %>%
  ggplot(aes(x = as.factor(S), y = effect_resilience_ratio, color = as.factor(C))) +
  geom_boxplot() +
  geom_hline(yintercept = 0)+
  labs(
    y = "Resilience effect (reintro - pred present)/pred present",
    x = "Initial foodweb richness",
    color = "Connectance"
    ) +
  facet_wrap(~metric, scales = "free_y") +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave(
  here::here("report", "figs", "p_resilience_effect.png"),
  plot = p_resilience_effect,
  scale = 2,
  width = 140,
  height = 140 * .5,
  units = "mm"
)
```


